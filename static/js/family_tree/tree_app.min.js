var TreeApp={person_id:0,people_hierarchy_order:[],person_by_id:{},relations_by_id:{},from_relations:{},to_relations:{}};$(document).ready(function(){person_id=parseInt(window.location.pathname.split("/")[2]);load_tree_data()});$(window).resize(function(){0<TreeApp.people_hierarchy_order.length&&redraw_tree()});function load_tree_data(){$(".loading").show();$.ajax({url:"/tree/data/",success:function(a){populate_lookups(a);redraw_tree();$(".loading").hide()}})}
function populate_lookups(a){for(var b=a.people.length,d=0;d<b;d++){var e={id:a.people[d][0],name:a.people[d][1],image:get_image_url(a.people[d][2]),hierarchy_score:a.people[d][3],relations:[]};TreeApp.person_by_id[a.people[d][0]]=e;TreeApp.people_hierarchy_order.push(e)}a=a.relations;b=a.length;for(d=0;d<b;d++){var c=a[d],e=c[0],f=c[1],p=c[2],c={id:e,from_person_id:f,to_person_id:p,relation_type:c[3]};TreeApp.person_by_id[f].relations.push(c);TreeApp.person_by_id[p].relations.push(c);TreeApp.relations_by_id[e]=
c;f in TreeApp.from_relations||(TreeApp.from_relations[f]={});TreeApp.from_relations[f][p]=c;p in TreeApp.to_relations||(TreeApp.to_relations[p]={});TreeApp.to_relations[p][f]=c}}function redraw_tree(){var a=get_related_people();html=build_tree(a);render_tree(html,a)}function render_tree(a,b){jsPlumb.detachEveryConnection();$("#family_tree_container").html("");$("#family_tree_container").append(a);draw_relations(b)}
function build_tree(a){var b=$("#container").width()-16,d,e;768>$("#container").width()?(d=90,e=140):(d=120,e=190);var c=$("#relative_person").html(),f=$("#relative_person_more_up").html(),p=$("#relative_person_more_down").html(),n=$("#relative_person_more_left").html(),r=$("#relative_person_more_right").html(),k=[],l=0;if(1<a.upper.length)for(var g=0,q=(b-a.upper.length*d)/(a.upper.length-1),m=0;m<a.upper.length;m++){var h=a.upper[m];a.relations_by_member_id[h.id].length<TreeApp.person_by_id[h.id].relations.length?
k.push(draw_relative(h,g,l,f)):k.push(draw_relative(h,g,l,c));g=g+d+q}1==a.upper.length&&(h=a.upper[0],g=(b-d)/2,a.relations_by_member_id[h.id].length<TreeApp.person_by_id[h.id].relations.length?k.push(draw_relative(h,g,l,f)):k.push(draw_relative(h,g,l,c)));l=e;if(0<a.same_level.length)for(var g=0,q=(b-a.same_level.length*d)/(a.same_level.length-1),f=1,t=(a.same_level.length+1)/2,m=0;m<a.same_level.length;m++)h=a.same_level[m],a.relations_by_member_id[h.id].length<TreeApp.person_by_id[h.id].relations.length?
f<=t?k.push(draw_relative(h,g,l,n)):k.push(draw_relative(h,g,l,r)):k.push(draw_relative(h,g,l,c)),f++,g=f<=t?g+q:g+d+q;k.push(draw_centred_person(b,d,l));l=l+e+60;if(1<a.lower.length)for(g=0,q=(b-a.lower.length*d)/(a.lower.length-1),m=0;m<a.lower.length;m++)h=a.lower[m],a.relations_by_member_id[h.id].length<TreeApp.person_by_id[h.id].relations.length?k.push(draw_relative(h,g,l,p)):k.push(draw_relative(h,g,l,c)),g=g+d+q;1==a.lower.length&&(g=(b-d)/2,h=a.lower[0],a.relations_by_member_id[h.id].length<
TreeApp.person_by_id[h.id].relations.length?k.push(draw_relative(h,g,l,p)):k.push(draw_relative(h,g,l,c)));return k.join("")}
function get_related_people(){for(var a=TreeApp.person_by_id[person_id].hierarchy_score,b={all_members:[],upper:[],same_level:[],lower:[],relations_by_id:{},members_by_id:{},relations_by_member_id:{},drawn_relations_by_id:{}},d=TreeApp.people_hierarchy_order.length,e=0;e<d;e++){var c=TreeApp.people_hierarchy_order[e];c.id in TreeApp.from_relations&&person_id in TreeApp.from_relations[c.id]&&(add_relative(b,c,a),b.all_members.push(c),b.members_by_id[c.id]=c,b.relations_by_member_id[c.id]=[]);c.id in
TreeApp.to_relations&&person_id in TreeApp.to_relations[c.id]&&(add_relative(b,c,a),b.all_members.push(c),b.members_by_id[c.id]=c,b.relations_by_member_id[c.id]=[])}for(var f in TreeApp.relations_by_id)a=TreeApp.relations_by_id[f],a.from_person_id in b.members_by_id&&a.to_person_id==person_id&&(b.relations_by_member_id[a.from_person_id].push(a),b.relations_by_id[a.id]=a,b.drawn_relations_by_id[a.id]=a),a.to_person_id in b.members_by_id&&a.from_person_id==person_id&&(b.relations_by_member_id[a.to_person_id].push(a),
b.relations_by_id[a.id]=a,b.drawn_relations_by_id[a.id]=a),a.from_person_id in b.members_by_id&&a.to_person_id in b.members_by_id&&(b.relations_by_member_id[a.to_person_id].push(a),b.relations_by_member_id[a.from_person_id].push(a),b.relations_by_id[a.id]=a,1==a.relation_type&&(b.drawn_relations_by_id[a.id]=a));return b}function add_relative(a,b,d){b.hierarchy_score<d?a.upper.push(b):b.hierarchy_score>d?a.lower.push(b):a.same_level.push(b)}
function draw_centred_person(a,b,d){var e=TreeApp.person_by_id[person_id];a=Math.round((a-b)/2);b=$("#centre_person").html();e.left=a;e.top=d;return Mustache.render(b,e)}function draw_relative(a,b,d,e){a.left=b;a.top=d;return Mustache.render(e,a)}function get_image_url(a){return a?"/media/"+a:"/static/img/portrait_80.png"}
function draw_relations(a){var b=$("#localization").data("raised"),d=$("#localization").data("partnered"),e=jsPlumb.getInstance({Endpoint:["Dot",{radius:2}],HoverPaintStyle:{strokeStyle:"#1e8151",lineWidth:2},Container:"family_tree_container"});window.jsp=e;var c=jsPlumb.getSelector(".family_tree_container .w");e.batch(function(){e.makeSource(c,{filter:".ep",anchor:"AutoDefault",connector:["StateMachine",{curviness:20}],connectorStyle:{strokeStyle:"#5c96bc",lineWidth:2,outlineColor:"transparent",
outlineWidth:4},maxConnections:15,onMaxConnections:function(a,b){alert("Maximum connections ("+a.maxConnections+") reached")}});e.makeTarget(c,{dropOptions:{hoverClass:"dragHover"},anchor:"AutoDefault",allowLoopback:!0});for(var f in a.drawn_relations_by_id){var n=a.drawn_relations_by_id[f],r="arrow"+n.id.toString(),k="label"+n.id.toString();1==n.relation_type?e.connect({source:n.from_person_id.toString(),target:n.to_person_id.toString(),overlays:[["Arrow",{location:1,direction:1,id:r}],["Arrow",
{location:0,direction:-1,id:"inverse_arrow"+n.id.toString()}],["Label",{label:d,id:k,cssClass:"aLabel"}]]}):e.connect({source:n.from_person_id.toString(),target:n.to_person_id.toString(),overlays:[["Arrow",{location:1,direction:1,id:r}],["Label",{label:b,id:k,cssClass:"aLabel"}]]})}});for(var f=0;f<a.all_members.length;f++)jsPlumb.on(document.getElementById(a.all_members[f].id.toString()),"click",function(a){a=$("#"+this.id).data("person_id");$old_person=$("#"+person_id.toString());$new_person=$("#"+
a);person_id=parseInt(a);var b=$old_person.offset().left-$new_person.offset().left,d=$old_person.offset().top-$new_person.offset().top;$("#family_tree_container").find("*").not("#"+a+",#"+a+" *").remove();var c,e=!1,g=!1;$new_person.animate({left:"+="+b.toString(),top:"+="+d.toString()},400,function(){e=!0;g&&e&&render_tree(c,f)});var f=get_related_people();c=build_tree(f);(g=!0,e)&&render_tree(c,f)})};
