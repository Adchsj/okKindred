define(["jquery","jsPlumb","mustache"],function(d,t,u){var p={person_id:0,people_hierarchy_order:[],person_by_id:{},relations_by_id:{},from_relations:{},to_relations:{},load_tree_data:function(){d(".loading").show();d.ajax({context:this,url:"/tree/data/",success:function(a){this.populate_lookups(a);this.redraw_tree();d(".loading").hide()}})},populate_lookups:function(a){for(var b=a.people.length,c=0;c<b;c++){var k={id:a.people[c][0],name:a.people[c][1],image:this.get_image_url(a.people[c][2]),hierarchy_score:a.people[c][3],
relations:[]};this.person_by_id[a.people[c][0]]=k;this.people_hierarchy_order.push(k)}a=a.relations;b=a.length;for(c=0;c<b;c++){var e=a[c],k=e[0],d=e[1],q=e[2],e={id:k,from_person_id:d,to_person_id:q,relation_type:e[3]};this.person_by_id[d].relations.push(e);this.person_by_id[q].relations.push(e);this.relations_by_id[k]=e;d in this.from_relations||(this.from_relations[d]={});this.from_relations[d][q]=e;q in this.to_relations||(this.to_relations[q]={});this.to_relations[q][d]=e}},redraw_tree:function(){var a=
this.get_related_people();html=this.build_tree(a);this.render_tree(html,a)},render_tree:function(a,b){t.detachEveryConnection();d("#family_tree_container").html("");d("#family_tree_container").append(a);this.draw_relations(b)},build_tree:function(a){var b=d("#container").width()-16,c,k;768>d("#container").width()?(c=90,k=140):(c=120,k=190);var e=d("#relative_person").html(),h=d("#relative_person_more_up").html(),q=d("#relative_person_more_down").html(),v=d("#relative_person_more_left").html(),w=d("#relative_person_more_right").html(),
l=[],m=0;if(1<a.upper.length)for(var g=0,r=(b-a.upper.length*c)/(a.upper.length-1),n=0;n<a.upper.length;n++){var f=a.upper[n];a.relations_by_member_id[f.id].length<this.person_by_id[f.id].relations.length?l.push(this.draw_relative(f,g,m,h)):l.push(this.draw_relative(f,g,m,e));g=g+c+r}1==a.upper.length&&(f=a.upper[0],g=(b-c)/2,a.relations_by_member_id[f.id].length<this.person_by_id[f.id].relations.length?l.push(this.draw_relative(f,g,m,h)):l.push(this.draw_relative(f,g,m,e)));m=k;if(0<a.same_level.length)for(var g=
0,r=(b-a.same_level.length*c)/(a.same_level.length-1),h=1,p=(a.same_level.length+1)/2,n=0;n<a.same_level.length;n++)f=a.same_level[n],a.relations_by_member_id[f.id].length<this.person_by_id[f.id].relations.length?h<=p?l.push(this.draw_relative(f,g,m,v)):l.push(this.draw_relative(f,g,m,w)):l.push(this.draw_relative(f,g,m,e)),h++,g=h<=p?g+r:g+c+r;l.push(this.draw_centred_person(b,c,m));m=m+k+60;if(1<a.lower.length)for(g=0,r=(b-a.lower.length*c)/(a.lower.length-1),n=0;n<a.lower.length;n++)f=a.lower[n],
a.relations_by_member_id[f.id].length<this.person_by_id[f.id].relations.length?l.push(this.draw_relative(f,g,m,q)):l.push(this.draw_relative(f,g,m,e)),g=g+c+r;1==a.lower.length&&(g=(b-c)/2,f=a.lower[0],a.relations_by_member_id[f.id].length<this.person_by_id[f.id].relations.length?l.push(this.draw_relative(f,g,m,q)):l.push(this.draw_relative(f,g,m,e)));return l.join("")},get_related_people:function(){for(var a=this.person_by_id[person_id].hierarchy_score,b={all_members:[],upper:[],same_level:[],lower:[],
relations_by_id:{},members_by_id:{},relations_by_member_id:{},drawn_relations_by_id:{},add_relative:function(a){this.all_members.push(a);this.members_by_id[a.id]=a;this.relations_by_member_id[a.id]=[]}},c=this.people_hierarchy_order.length,d=0;d<c;d++){var e=this.people_hierarchy_order[d];e.id in this.from_relations&&person_id in this.from_relations[e.id]&&(this.add_relative(b,e,a),b.add_relative(e));e.id in this.to_relations&&person_id in this.to_relations[e.id]&&(this.add_relative(b,e,a),b.add_relative(e))}for(var h in this.relations_by_id)a=
this.relations_by_id[h],a.from_person_id in b.members_by_id&&a.to_person_id==person_id&&(b.relations_by_member_id[a.from_person_id].push(a),b.relations_by_id[a.id]=a,b.drawn_relations_by_id[a.id]=a),a.to_person_id in b.members_by_id&&a.from_person_id==person_id&&(b.relations_by_member_id[a.to_person_id].push(a),b.relations_by_id[a.id]=a,b.drawn_relations_by_id[a.id]=a),a.from_person_id in b.members_by_id&&a.to_person_id in b.members_by_id&&(b.relations_by_member_id[a.to_person_id].push(a),b.relations_by_member_id[a.from_person_id].push(a),
b.relations_by_id[a.id]=a,1==a.relation_type&&(b.drawn_relations_by_id[a.id]=a));return b},add_relative:function(a,b,c){b.hierarchy_score<c?a.upper.push(b):b.hierarchy_score>c?a.lower.push(b):a.same_level.push(b)},draw_centred_person:function(a,b,c){var k=this.person_by_id[person_id];a=Math.round((a-b)/2);b=d("#centre_person").html();k.left=a;k.top=c;return u.render(b,k)},draw_relative:function(a,b,c,d){a.left=b;a.top=c;return u.render(d,a)},get_image_url:function(a){return a?"/media/"+a:"/static/img/portrait_80.png"},
draw_relations:function(a){var b=d("#localization").data("raised"),c=d("#localization").data("partnered"),k=t.getInstance({Endpoint:["Dot",{radius:2}],HoverPaintStyle:{strokeStyle:"#1e8151",lineWidth:2},Container:"family_tree_container"});window.jsp=k;var e=t.getSelector(".family_tree_container .w");k.batch(function(){k.makeSource(e,{filter:".ep",anchor:"AutoDefault",connector:["StateMachine",{curviness:20}],connectorStyle:{strokeStyle:"#5c96bc",lineWidth:2,outlineColor:"transparent",outlineWidth:4},
maxConnections:15,onMaxConnections:function(a,b){alert("Maximum connections ("+a.maxConnections+") reached")}});k.makeTarget(e,{dropOptions:{hoverClass:"dragHover"},anchor:"AutoDefault",allowLoopback:!0});for(var d in a.drawn_relations_by_id){var h=a.drawn_relations_by_id[d],p="arrow"+h.id.toString(),l="label"+h.id.toString();1==h.relation_type?k.connect({source:h.from_person_id.toString(),target:h.to_person_id.toString(),overlays:[["Arrow",{location:1,direction:1,id:p}],["Arrow",{location:0,direction:-1,
id:"inverse_arrow"+h.id.toString()}],["Label",{label:c,id:l,cssClass:"aLabel"}]]}):k.connect({source:h.from_person_id.toString(),target:h.to_person_id.toString(),overlays:[["Arrow",{location:1,direction:1,id:p}],["Label",{label:b,id:l,cssClass:"aLabel"}]]})}});for(var h=0;h<a.all_members.length;h++)t.on(document.getElementById(a.all_members[h].id.toString()),"click",function(a,b){var c=d("#"+this.id).data("person_id");$old_person=d("#"+person_id.toString());$new_person=d("#"+c);person_id=parseInt(c);
var e=$old_person.offset().left-$new_person.offset().left,k=$old_person.offset().top-$new_person.offset().top;d("#family_tree_container").find("*").not("#"+c+",#"+c+" *").remove();var g,h=!1,n=!1;$new_person.animate({left:"+="+e.toString(),top:"+="+k.toString()},400,function(){h=!0;n&&h&&p.render_tree(g,f)});var f=p.get_related_people();g=p.build_tree(f);(n=!0,h)&&p.render_tree(g,f)})}};d(document).ready(function(){person_id=parseInt(window.location.pathname.split("/")[2]);p.load_tree_data()});d(window).resize(function(){0<
p.people_hierarchy_order.length&&p.redraw_tree()})});
